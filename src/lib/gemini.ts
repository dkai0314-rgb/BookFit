
import { GoogleGenerativeAI } from "@google/generative-ai";

const apiKey = process.env.GEMINI_API_KEY!;
const genAI = new GoogleGenerativeAI(apiKey);

export type RecommendMode = 'TASTE' | 'MIND';

export interface RecommendationRequest {
    mode: RecommendMode;
    // Taste inputs
    topics?: string[];
    style?: string;
    customQuery?: string; // New: Natural language query for Taste
    // Mind inputs
    emotion?: string[];
    situation?: string;
}

export interface RecommendedBookBase {
    title: string;
    author: string;
    reason: string;
    coreMessage: string;
    userConnectionPoint: string;
}

export async function getRecommendations(request: RecommendationRequest): Promise<RecommendedBookBase[]> {
    const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash" });

    let prompt = "";

    if (request.mode === 'TASTE') {
        prompt = `
        [Role]
        ?¹ì‹ ?€ "Premium High-End Book Curator"?…ë‹ˆ?? 
        ?¬ìš©?ì˜ ì§€???¸ê¸°?¬ê³¼ êµ¬ì²´?ì¸ ?”êµ¬?¬í•­???„ë²½?˜ê²Œ ì¶©ì¡±?œì¼œì¤?ì±…ì„ 5ê¶??„ì„ ?´ì£¼?¸ìš”. (??ì¤?ê²€ì¦ëœ ?ìœ„ 3ê¶Œë§Œ ?¬ìš©?ì—ê²?ë³´ì—¬ì¤??ˆì •?…ë‹ˆ??

        [User Request]
        - ?¬ìš©?ì˜ êµ¬ì²´?ì¸ ?”êµ¬?¬í•­(Natural Language): "${request.customQuery || "ë³„ë„ ?”ì²­ ?†ìŒ"}"
        - ê´€???¤ì›Œ??Tags): ${request.topics?.join(", ") || "?†ìŒ"}
        - ? í˜¸ ?¤í??? ${request.style || "?ê??†ìŒ"}

        [Task]
        1. **ìµœìš°???œìœ„**: ?¬ìš©?ê? ?‘ì„±??"êµ¬ì²´?ì¸ ?”êµ¬?¬í•­" ?ìŠ¤?¸ë? ë©´ë???ë¶„ì„?˜ì—¬, ?¨ìˆœ??ì£¼ì œ ë§¤ì¹­???˜ì–´ ?¬ìš©?ì˜ 'ì§„ì§œ ?˜ë„(?œì´?? ëª©ì , ê¹Šì´)'ë¥??Œì•…?˜ì‹­?œì˜¤.
        2. ?´ë‹¹ ?˜ë„??ê°€??ë¶€?©í•˜??ê³ í’ˆì§ˆì˜ ?„ì„œ 5ê¶Œì„ ? ì •?˜ì‹­?œì˜¤. (ë°˜ë“œ???¤ì œë¡?ì¶œíŒ?? ISBN??ì¡´ì¬?˜ëŠ” ì±…ì´?´ì•¼ ?©ë‹ˆ?? ?†ëŠ” ì±…ì´??ê°€?ì˜ ?œëª©??ì§€?´ë‚´ì§€ ë§ˆì‹­?œì˜¤.)
        3. ê°?ì±…ì— ?€??êµ¬ì²´?ì´ê³??¼ë¦¬?ì¸ ì¶”ì²œ ?´ìœ ë¥??‘ì„±?˜ì‹­?œì˜¤. (ì¶”ìƒ?ì¸ ì¹?°¬ ê¸ˆì?)

        [Output Format]
        JSON Array ?•íƒœë¡??¤ìŒ ?„ë“œë¥??¬í•¨?´ì•¼ ?©ë‹ˆ??
        - title: ì±??œëª© (?•í™•?˜ê²Œ)
        - author: ?€???´ë¦„
        - coreMessage: ??ì±…ì˜ ?µì‹¬ ë©”ì‹œì§€ ??ë¬¸ì¥
        - reason: ì¶”ì²œ ?´ìœ  (2~3ë¬¸ì¥, ?¬ìš©?ì˜ ê´€?¬ì‚¬/ëª©ì ê³?êµ¬ì²´?ìœ¼ë¡??°ê²°)
        - userConnectionPoint: ?¬ìš©?ì˜ ?…ë ¥(?¤ì›Œ??ëª©ì )ê³??°ê²°?˜ëŠ” ?µì‹¬ ?¬ì¸??(?¨ë‹µ??

        * ?‘ë‹µ?€ ?¤ì§ JSON ?°ì´?°ë§Œ ì¶œë ¥?˜ì‹­?œì˜¤. ë§ˆí¬?¤ìš´ ?¬ë§·???†ì´.
        `;
    } else {
        prompt = `
        [Role]
        ?¹ì‹ ?€ "Soul Therapist & Book Curator"?…ë‹ˆ??
        ?¬ìš©?ì˜ ê°ì •ê³??í™©??ê¹Šì´ ê³µê°?˜ê³ , ì±??ì˜ ë¬¸ì¥?¼ë¡œ ?„ë¡œ?€ ?´ë‹µ??ê±´ë„¤ì£¼ì„¸??

        [User Emotion/Situation]
        - ?¬ìš©?ê? ì§ì ‘ ?‘ì„±???í™©/ê³ ë?: "${request.situation || "ë³„ë„ ?¤ëª… ?†ìŒ"}"
        - ì°¸ê³ ??ê°ì • ?¤ì›Œ?? ${request.emotion?.join(", ") || "?†ìŒ"}

        [Task]
        1. **ìµœìš°???œìœ„**: ?¬ìš©?ê? ?‘ì„±??"?í™”/ê³ ë?" ?ìŠ¤?¸ë? ê¹Šì´ ?½ê³ , ê·??ˆì— ?¨ê²¨ì§?ê°ì •ê³??˜ì•™?? ê²°í•??ë¶„ì„?˜ì‹­?œì˜¤. (?¤ì›Œ?œëŠ” ?¨ìˆœ ì°¸ê³ ?©ì…?ˆë‹¤)
        2. ?¨ìˆœ???¤ì›Œ??ë§¤ì¹­???„ë‹ˆ?? ?¬ìš©?ì˜ êµ¬ì²´?ì¸ ?í™©??ê³µê°?˜ê³  ?¤ì§ˆ?ì¸ ?„ë¡œë¥?ì¤????ˆëŠ” ì±?5ê¶Œì„ ? ì •?˜ì‹­?œì˜¤. (ë°˜ë“œ???¤ì œë¡?ì¶œíŒ?? ISBN??ì¡´ì¬?˜ëŠ” ì±…ì´?´ì•¼ ?©ë‹ˆ?? ?†ëŠ” ì±…ì´??ê°€?ì˜ ?œëª©??ì§€?´ë‚´ì§€ ë§ˆì‹­?œì˜¤.)
        3. ë»”í•œ ?ê¸°ê³„ë°œ?œë³´?¤ëŠ”, ë§ˆìŒ???´ë£¨ë§Œì????ì„¸?? ?¬ë¦¬?? ?¹ì? ê¹Šì´ ?ˆëŠ” ?¸ë¬¸???„ì„œë¥??°ì„  ê³ ë ¤?˜ì‹­?œì˜¤.
        4. "ì²˜ë°©"???„ë‹Œ "?™í–‰"???¸ì–´ë¡?ì¶”ì²œ ?´ìœ ë¥??‘ì„±?˜ì‹­?œì˜¤. (~?´ìš”ì²?

        [Output Format]
        JSON Array ?•íƒœë¡??¤ìŒ ?„ë“œë¥??¬í•¨?´ì•¼ ?©ë‹ˆ??
        - title: ì±??œëª© (?•í™•?˜ê²Œ)
        - author: ?€???´ë¦„
        - coreMessage: ??ì±…ì´ ?„í•˜???°ëœ»??ë©”ì‹œì§€ ??ë¬¸ì¥
        - reason: ì¶”ì²œ ?´ìœ  (2~3ë¬¸ì¥, ê¸°ë? ?¨ê³¼?€ ?„ë¡œ??ë©”ì‹œì§€ ì¤‘ì‹¬, ~?´ìš”ì²?
        - userConnectionPoint: ?¬ìš©?ì˜ ê°ì •/?íƒœ?€ ?°ê²°?˜ëŠ” ?¬ì¸??(?? ë¶ˆì•ˆ??? ì¬?°ëŠ” ë¬¸ì¥)

        * ?‘ë‹µ?€ ?¤ì§ JSON ?°ì´?°ë§Œ ì¶œë ¥?˜ì‹­?œì˜¤. ë§ˆí¬?¤ìš´ ?¬ë§·???†ì´.
        `;
    }

    try {
        const result = await model.generateContent(prompt);
        const text = result.response.text();
        // Remove markdown formatting if present
        const jsonStr = text.replace(/```json/g, '').replace(/```/g, '').trim();
        return JSON.parse(jsonStr);
    } catch (error) {
        console.error("Gemini Recommendation Error:", error);
        return [];
    }
}
